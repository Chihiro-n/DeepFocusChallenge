# EXP000: 手作り特徴量によるSEMデフォーカス推定

## サマリー

| 指標 | 値 |
|------|-----|
| CV RMSE | 20.46 |
| LB Score | 30.05 |
| 特徴量数 | 3 |
| モデル | Ridge回帰 |

---

## 1. アプローチ概要

### 課題設定
SEM（走査電子顕微鏡）画像のデフォーカス量を定量化する必要がある。課題の難しさ：
- 学習データは**ベストフォーカス画像のみ**（abs_focus = 0）
- テストデータは**様々なデフォーカスレベル**を含む
- 複数の撮像条件（パターン）が存在し、それぞれ特性が異なる

### 初期仮説（棄却）
最初に**Depth Anything v3**を使用して深度マップを推定し、表面の凹凸がデフォーカスと相関すると仮説を立てた。しかし、SEM画像では**逆相関**を示したため、このアプローチは棄却した。

### 最終アプローチ：物理ベースのボケ特徴量
古典的な画像処理技術を用いて、ボケの特性を直接測定する方向に転換：

```
デフォーカス → 高周波成分の減衰 → 勾配/FFTで測定可能
```

---

## 2. 特徴量エンジニアリング

### 選択した特徴量（3個）

| 特徴量 | 説明 | 物理的意味 |
|--------|------|----------|
| `local_contrast_std` | 局所コントラストマップの標準偏差 | テクスチャのシャープさのばらつきを測定 |
| `fft_mid_ratio` | FFTスペクトルの中周波エネルギー比率 | シャープな画像は中周波成分が多い |
| `sobel_max` | 勾配の最大値 | シャープなエッジは高い勾配ピークを生成 |

### なぜこれらの特徴量を選んだか？

**重要な発見：全体相関 vs パターン内相関**

一部の特徴量は高い**全体相関**を示すが、特定のパターン内では機能しないことを発見：

| 特徴量 | 全体相関 | Pattern 1での相関 | 信頼性 |
|--------|---------|------------------|--------|
| `img_mean` | 0.79 | ≈0 | 使えない |
| `local_contrast_std` | -0.94〜-0.99 | -0.94〜-0.99 | **信頼できる** |
| `fft_mid_ratio` | -0.88〜-0.99 | -0.88〜-0.99 | **信頼できる** |
| `sobel_max` | -0.78〜-0.96 | -0.78〜-0.96 | **信頼できる** |

**重要な知見**：特徴量は全体ではなく、**各パターン内で一貫した相関**を示す必要がある。

---

## 3. 実装

### 特徴量抽出

```python
def extract_blur_features(image_path: str) -> dict:
    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)

    # 1. 局所コントラスト（5x5カーネル）
    local_mean = cv2.blur(img, (5, 5))
    local_sq_mean = cv2.blur(img ** 2, (5, 5))
    local_std = np.sqrt(local_sq_mean - local_mean ** 2)
    features['local_contrast_std'] = local_std.std()

    # 2. FFT中周波比率
    magnitude = np.abs(np.fft.fftshift(np.fft.fft2(img)))
    # 中周波：中心からの最大距離の10-30%
    features['fft_mid_ratio'] = mid_energy / total_energy

    # 3. Sobel最大値
    sobel_mag = np.sqrt(sobel_x**2 + sobel_y**2)
    features['sobel_max'] = sobel_mag.max()

    return features
```

### モデル学習

```python
# シンプルなRidge回帰
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X[['local_contrast_std', 'fft_mid_ratio', 'sobel_max']])
model = Ridge(alpha=1.0)
model.fit(X_scaled, y)
```

---

## 4. 結果

### パターン別性能

| パターン | RMSE | 備考 |
|---------|------|------|
| Pattern 0 | ≈15 | 良好 |
| Pattern 1 | ≈25 | 最悪（撮像条件が異なる） |
| Pattern 2 | ≈18 | 中程度 |
| Pattern 3 | ≈20 | 中程度 |
| Pattern 4 | ≈12 | 最良 |

### 特徴量の係数

選択した全特徴量が**負の係数**を示し、以下を確認：
- ボケが強い → 特徴量値が低い
- これはデフォーカスの物理的理解と一致

---

## 5. このアプローチの重要性

### 優位性

1. **物理ベース**：光学で定義されるボケ特性を直接測定
2. **ドメイン不変**：勾配・周波数特徴量は輝度/コントラスト変化に強い
3. **解釈可能**：各特徴量に明確な物理的意味がある
4. **高速**：深層学習不要、高速な推論

### 特定された限界

1. **Pattern 1問題**：一部のパターンは根本的に特性が異なる
2. **線形モデル**：Ridge回帰は非線形関係を捉えられない可能性
3. **特徴量数**：3特徴量では不十分かもしれない

### 今後の研究への基盤

この実験で確立したこと：
- **信頼できる特徴量選択手法**（パターン内相関チェック）
- **ベースライン性能**（LB 30.05）
- **問題構造の理解**（Pattern 1が問題）

これらの知見が後続実験につながった：
- EXP001: LightGBM + 33特徴量 → LB 23.65
- EXP003: DeepResearch特徴量（60個） → LB 19.16（ベスト）

---

## 6. 重要なポイント

1. **全体相関を信じるな** - 常にパターン内での一貫性をチェックすべき
2. **物理ベース特徴量は有効** - 勾配・周波数特徴量はボケを効果的に捉える
3. **シンプルなモデルには限界がある** - Ridge回帰は良いベースラインだが不十分
4. **パターンの異質性が重要** - 異なる撮像条件にはロバストな特徴量が必要

---

## ファイル構成

```
EXP/EXP000/
├── infer.py                    # メイン推論スクリプト
├── test_blur_features.py       # 特徴量抽出のテスト
├── analyze_sample_correlation.py # 相関分析
├── config/
│   └── child-exp000.yaml       # 設定ファイル
└── outputs/
    ├── submission.csv          # 提出ファイル
    ├── sample_features.csv     # 抽出された特徴量
    └── prediction_distribution.png
```

## 使用方法

```bash
python EXP/EXP000/infer.py
```
